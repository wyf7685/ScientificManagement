<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.achievement.mapper.AchievementMainsMapper">


    <resultMap id="AchListVOMap" type="com.achievement.domain.vo.AchListVO">
        <result column="documentId" property="documentId"/>
        <result column="title" property="title"/>
        <result column="typeName" property="typeName"/>
        <result column="auditStatus" property="auditStatus"/>
        <result column="creatorName" property="creatorName"/>
        <result column="year" property="year"/>
        <result column="keywords" property="keywords"
                typeHandler="com.achievement.utils.JsonStringListTypeHandler"/>
        <!-- 关键：authors 用 JSON List TypeHandler -->
        <result column="authors" property="authors"
                typeHandler="com.achievement.utils.JsonStringListTypeHandler"/>

        <result column="projectName" property="projectName"/>
        <result column="summary" property="summary"/>
        <result column="createdAt" property="createdAt"/>
        <result column="visibilityRange" property="visibilityRange"/>
    </resultMap>

<!-- 其他自动生成的 CRUD 在这里... -->
<!-- 分页查询成果物列表 -->
    <select id="pageList" resultMap="AchListVOMap">
        SELECT
        m.document_id        AS documentId,
        m.title              AS title,
        t.type_name          AS typeName,
        m.achievement_status AS auditStatus,
        m.keywords         AS mainTitle,
        m.authors          AS authors,
        m.year              AS year,
        m.project_name       AS projectName,
        m.summary            AS summary,
        m.created_at         AS createdAt,
        m.visibility_range   AS visibilityRange,
        m.created_by_user_id      AS creatorId
        FROM achievement_mains m

        LEFT JOIN achievement_mains_achievement_type_id_lnk mt
        ON mt.achievement_main_id = m.id
        LEFT JOIN achievement_types t
        ON t.id = mt.achievement_type_id
        LEFT JOIN business_users au
        ON au.id = m.created_by_id

        <!-- 方式B：如果是 Strapi 多对多/多对一 link 表（按你实际表名改）
        LEFT JOIN achievement_mains_project_id_lnk mp
            ON mp.achievement_main_id = m.id
        LEFT JOIN projects p
            ON p.id = mp.project_id
        -->

        WHERE m.is_delete = 0
        AND m.published_at IS NOT NULL

        <!-- 个人成果物：强制按创建者过滤
        AND m.created_by_id = #{dto.creatorId}-->
        <if test="dto.title!=null and dto.title !=''">
            AND m.title LIKE CONCAT('%', #{dto.title}, '%')
        </if>
        <if test="dto.status != null and dto.status != ''">
            AND m.achievement_status = #{dto.status}
        </if>

        <!-- 只有在明确查询待分配审核的成果时才添加未分配审核人的条件 -->
        <if test="dto.onlyUnassigned != null and dto.onlyUnassigned == true and dto.status == 'PENDING'">
            AND m.reviewer_id IS NULL
        </if>

        <if test="dto.typeId != null">
            AND mt.achievement_type_id = #{dto.typeId}
        </if>
        <if test="dto.typeCode != null and dto.typeCode != ''">
            AND t.type_code = #{dto.typeCode}
        </if>
        <if test="dto.author != null and dto.author.trim() != ''">
            AND (
            JSON_SEARCH(m.authors, 'one', CONCAT('%', TRIM(#{dto.author}), '%')) IS NOT NULL
            OR JSON_SEARCH(m.authors, 'all', CONCAT('%', TRIM(#{dto.author}), '%')) IS NOT NULL
            )
        </if>
        <if test="dto.keyword != null and dto.keyword.trim() != ''">
            AND (
            JSON_SEARCH(m.keywords, 'one', CONCAT('%', TRIM(#{dto.keyword}), '%')) IS NOT NULL
            OR JSON_SEARCH(m.keywords, 'all', CONCAT('%', TRIM(#{dto.keyword}), '%')) IS NOT NULL
            )
        </if>
        <if test="dto.visibilityRange != null and dto.visibilityRange != ''">
            AND m.visibility_range = #{dto.visibilityRange}
        </if>
        <!-- 成果物年份范围：按 m.year（String）字段，区间 [yearStart, yearEnd] -->
        <if test="dto.yearStart != null and dto.yearStart != '' and dto.yearEnd != null and dto.yearEnd != ''">
            AND m.`year` IS NOT NULL
            AND CAST(m.`year` AS UNSIGNED) <![CDATA[ >= ]]> CAST(#{dto.yearStart} AS UNSIGNED)
            AND CAST(m.`year` AS UNSIGNED) <![CDATA[ <= ]]> CAST(#{dto.yearEnd} AS UNSIGNED)
        </if>

        <!-- 可选：只传 start 或只传 end 时也能用 -->
        <if test="(dto.yearStart != null and dto.yearStart != '') and (dto.yearEnd == null or dto.yearEnd == '')">
            AND m.`year` IS NOT NULL
            AND CAST(m.`year` AS UNSIGNED) <![CDATA[ >= ]]> CAST(#{dto.yearStart} AS UNSIGNED)
        </if>

        <if test="(dto.yearEnd != null and dto.yearEnd != '') and (dto.yearStart == null or dto.yearStart == '')">
            AND m.`year` IS NOT NULL
            AND CAST(m.`year` AS UNSIGNED) <![CDATA[ <= ]]> CAST(#{dto.yearEnd} AS UNSIGNED)
        </if>
        ORDER BY m.created_at DESC
    </select>

    <select id="countByType" resultType="com.achievement.domain.vo.TypeCountVO">
        SELECT
        t.type_name AS typeName,
        t.type_code AS typeCode,
        COUNT(DISTINCT m.id) AS count
        FROM achievement_types t
        LEFT JOIN achievement_mains_achievement_type_id_lnk mt
        ON mt.achievement_type_id = t.id
        LEFT JOIN achievement_mains m
        ON m.id = mt.achievement_main_id
        AND m.is_delete = 0
        AND m.published_at IS NOT NULL
        AND m.achievement_status = 'APPROVED'
        <if test="creatorId != null">
            AND m.created_by_user_id = #{creatorId}
        </if>
        WHERE t.is_delete = 0
        GROUP BY t.id, t.type_name, t.type_code
        ORDER BY count DESC
    </select>

    <select id="selectMainBaseByDocId" resultType="com.achievement.domain.dto.AchMainBaseRow">
        SELECT
            m.id            AS mainId,
            m.document_id   AS documentId,
            m.title         AS title,
            m.summary       AS summary,
            m.achievement_status AS auditStatus,
            m.created_at    AS createdAt,
            m.updated_at    AS updatedAt,
            m.published_at  AS publishedAt,
            m.created_by_user_id AS createdByUserId,
            t.id            AS typeId,
            t.document_id   AS typeDocId,
            t.type_name     AS typeName,
            t.type_code     AS typeCode,
            m.year          AS year,
            m.authors       AS authorsJson,
            m.keywords      AS keywordsJson,
            m.project_code  AS projectCode,
            m.project_name  AS projectName,
            m.visibility_range AS visibilityRange
        FROM achievement_mains m
                 LEFT JOIN achievement_mains_achievement_type_id_lnk mt
                           ON mt.achievement_main_id = m.id
                 LEFT JOIN achievement_types t
                           ON t.id = mt.achievement_type_id
        WHERE m.is_delete = 0
          AND m.document_id = #{docId}
        ORDER BY (m.published_at IS NOT NULL) DESC, m.updated_at DESC
        LIMIT 1
    </select>
    <select id="selectFieldRows" resultType="com.achievement.domain.dto.AchFieldRow">
        SELECT
            d.id            AS fieldId,
            d.document_id   AS documentId,
            d.field_code    AS fieldCode,
            d.field_name    AS fieldName,
            d.field_type    AS fieldType,
            d.is_required   AS isRequired,

            v.text_value    AS textValue,
            v.boolean_value AS booleanValue,
            v.number_value  AS numberValue,
            v.date_value    AS dateValue,
            v.email_value   AS emailValue
        FROM achievement_field_values_achievement_id_lnk avl
                 JOIN achievement_field_values v
                      ON v.id = avl.achievement_field_value_id
                 JOIN achievement_field_defs_achievement_field_value_id_lnk dvl
                      ON dvl.achievement_field_value_id = v.id
                 JOIN achievement_field_defs d
                      ON d.id = dvl.achievement_field_def_id
                 JOIN achievement_field_defs_achievement_type_id_lnk dtl
                      ON dtl.achievement_field_def_id = d.id
                          AND dtl.achievement_type_id = #{typeId}
        WHERE avl.achievement_main_id = #{mainId}
          AND (v.is_delete IS NULL OR v.is_delete = 0)
          AND (d.is_delete IS NULL OR d.is_delete = 0)
        ORDER BY dtl.achievement_field_def_ord ASC
    </select>
    <select id="pageList2" resultMap="AchListVOMap">
        SELECT
        m.document_id                 AS documentId,
        m.title              AS title,
        t.type_name          AS typeName,
        m.achievement_status AS auditStatus,
        m.authors          AS authors,
        m.year              AS year,
        m.keywords         AS keywords,
        /*,
        p.project_name       AS projectName,*/
        m.summary            AS summary,
        m.created_at         AS createdAt,
        m.visibility_range      AS visibilityRange
        FROM achievement_mains m

        LEFT JOIN achievement_mains_achievement_type_id_lnk mt
        ON mt.achievement_main_id = m.id
        LEFT JOIN achievement_types t
        ON t.id = mt.achievement_type_id

        /*LEFT JOIN admin_users au
        ON au.id = m.created_by_id

        LEFT JOIN projects p
        ON p.id = m.project_id*/

        WHERE m.is_delete = 0
        AND m.published_at IS NOT NULL

        <!-- 只查 ALL 可见 -->
        AND m.visibility_range = 'public'
        AND m.achievement_status = 'APPROVED'
        <!-- 个人成果物：强制按创建者过滤
        AND m.created_by_id = #{dto.creatorId}-->
        <!-- 成果物类型筛选 -->
        <if test="dto.typeId != null">
            AND mt.achievement_type_id = #{dto.typeId}
        </if>
        <if test="dto.typeCode != null and dto.typeCode != ''">
            AND t.type_code = #{dto.typeCode}
        </if>
        <!-- 成果物年份范围：按 m.year（String）字段，区间 [yearStart, yearEnd] -->
        <if test="dto.yearStart != null and dto.yearStart != '' and dto.yearEnd != null and dto.yearEnd != ''">
            AND m.`year` IS NOT NULL
            AND CAST(m.`year` AS UNSIGNED) <![CDATA[ >= ]]> CAST(#{dto.yearStart} AS UNSIGNED)
            AND CAST(m.`year` AS UNSIGNED) <![CDATA[ <= ]]> CAST(#{dto.yearEnd} AS UNSIGNED)
        </if>

        <!-- 可选：只传 start 或只传 end 时也能用 -->
        <if test="(dto.yearStart != null and dto.yearStart != '') and (dto.yearEnd == null or dto.yearEnd == '')">
            AND m.`year` IS NOT NULL
            AND CAST(m.`year` AS UNSIGNED) <![CDATA[ >= ]]> CAST(#{dto.yearStart} AS UNSIGNED)
        </if>

        <if test="(dto.yearEnd != null and dto.yearEnd != '') and (dto.yearStart == null or dto.yearStart == '')">
            AND m.`year` IS NOT NULL
            AND CAST(m.`year` AS UNSIGNED) <![CDATA[ <= ]]> CAST(#{dto.yearEnd} AS UNSIGNED)
        </if>


        ORDER BY m.created_at DESC
    </select>

    <!-- 分页查询审核待办列表 -->
    <select id="pageReviewBacklog" resultType="com.achievement.domain.vo.ReviewBacklogVO">
        SELECT
            m.document_id    AS id,
            m.title          AS title,
            t.type_name      AS type,
            m.project_name   AS projectName,
            m.project_code   AS projectCode,
            m.created_by_user_id   AS creatorId,
            m.created_at     AS createdAt,
            m.achievement_status AS status
        FROM achievement_mains m
        LEFT JOIN achievement_mains_achievement_type_id_lnk mt
            ON mt.achievement_main_id = m.id
        LEFT JOIN achievement_types t
            ON t.id = mt.achievement_type_id
        WHERE m.is_delete = 0
          AND m.published_at IS NOT NULL
          AND m.achievement_status = 'UNDER_REVIEW'
          AND (m.reviewer_id = #{reviewerId} OR m.reviewer_id IS NULL)
        ORDER BY m.created_at ASC
    </select>

    <!-- 分页查询审核历史列表 -->
    <select id="pageReviewHistory" resultType="com.achievement.domain.vo.ReviewHistoryVO">
        SELECT
            m.document_id    AS id,
            m.title          AS title,
            t.type_name      AS type,
            m.project_name   AS projectName,
            m.project_code   AS projectCode,
            CASE 
                WHEN m.achievement_status = 'APPROVED' THEN 'approve'
                WHEN m.achievement_status = 'REJECTED' THEN 'reject'
                ELSE 'unknown'
            END              AS reviewResult,
            m.reviewed_at    AS reviewedAt,
            m.review_comment AS comment
        FROM achievement_mains m
        LEFT JOIN achievement_mains_achievement_type_id_lnk mt
            ON mt.achievement_main_id = m.id
        LEFT JOIN achievement_types t
            ON t.id = mt.achievement_type_id
        WHERE m.is_delete = 0
          AND m.published_at IS NOT NULL
          AND m.reviewer_id = #{reviewerId}
          AND m.achievement_status IN ('APPROVED', 'REJECTED')
          AND m.reviewed_at IS NOT NULL
        ORDER BY m.reviewed_at DESC
    </select>
    <select id="countTotalByUser" resultType="java.lang.Integer">
            SELECT COUNT(1)
            FROM achievement_mains m
            WHERE m.is_delete = 0
              AND m.published_at IS NOT NULL
              AND m.achievement_status = 'APPROVED'
              AND m.created_by_id = #{userId}
    </select>
    <select id="countMonthNewByUser" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM achievement_mains m
        WHERE m.is_delete = 0
          AND m.published_at IS NOT NULL
          AND m.achievement_status = 'APPROVED'
          AND m.created_by_id = #{userId}
          AND m.created_at <![CDATA[ >= ]]> #{start}
          AND m.created_at <![CDATA[ < ]]> #{end}
    </select>
    <select id="countByTypeCodeForUser" resultType="java.lang.Integer">

            SELECT COUNT(DISTINCT m.id)
            FROM achievement_mains m
                     LEFT JOIN achievement_mains_achievement_type_id_lnk mt
                               ON mt.achievement_main_id = m.id
                     LEFT JOIN achievement_types t
                               ON t.id = mt.achievement_type_id
            WHERE m.is_delete = 0
              AND m.published_at IS NOT NULL
              AND m.achievement_status = 'APPROVED'
              AND m.created_by_id = #{userId}
              AND t.is_delete = 0
              AND UPPER(t.type_code) LIKE CONCAT('%', UPPER(#{typeCode}), '%')

    </select>
    <select id="countTotal" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM achievement_mains m
        WHERE m.is_delete = 0
          AND m.published_at IS NOT NULL
          AND m.achievement_status = 'APPROVED'
    </select>
    <select id="countMonthNew" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM achievement_mains m
        WHERE m.is_delete = 0
          AND m.published_at IS NOT NULL
          AND m.achievement_status = 'APPROVED'
          AND m.created_at <![CDATA[ >= ]]> #{start}
          AND m.created_at <![CDATA[ < ]]> #{end}
    </select>
    <select id="countByTypeCode" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT m.id)
        FROM achievement_mains m
                 LEFT JOIN achievement_mains_achievement_type_id_lnk mt
                           ON mt.achievement_main_id = m.id
                 LEFT JOIN achievement_types t
                           ON t.id = mt.achievement_type_id
        WHERE m.is_delete = 0
          AND m.published_at IS NOT NULL
          AND m.achievement_status = 'APPROVED'
          AND t.is_delete = 0
          AND UPPER(t.type_code) LIKE CONCAT('%', UPPER(#{typeCode}), '%')

    </select>
    <select id="countYearlyTrendByUser" resultType="com.achievement.domain.vo.YearTrendItem">

        <!--这里暂不确定取决的是created_at 还是year
        SELECT
            YEAR(created_at) AS year,

            COUNT(1) AS count
        FROM achievement_mains
        WHERE created_by_user_id = #{userId}
          AND (is_delete IS NULL OR is_delete = 0)
          AND created_at IS NOT NULL
          AND YEAR(created_at) <![CDATA[>=]]> #{fromYear}
          AND YEAR(created_at) <![CDATA[<=]]> #{toYear}
        GROUP BY YEAR(created_at)
        ORDER BY YEAR(created_at)
        -->
        SELECT
        `year` AS year,
        COUNT(1) AS count
        FROM achievement_mains
        WHERE created_by_user_id = #{userId}
        AND (is_delete IS NULL OR is_delete = 0)
        AND `year` IS NOT NULL
        AND `year` <![CDATA[>=]]> #{fromYear}
        AND `year` <![CDATA[<=]]> #{toYear}
        AND published_at IS NOT NULL
        AND achievement_status = 'APPROVED' <!--产出的成果物需要是审核通过的-->
        GROUP BY `year`
        ORDER BY `year`
    </select>
    <select id="countTypeYearTrend" resultType="com.achievement.domain.vo.TypeYearTrendRow">
        SELECT
        CAST(m.year AS UNSIGNED) AS year,
        COALESCE(t.type_code, 'UNKNOWN') AS typeCode,
        COALESCE(t.type_name, t.type_code, '未知类型') AS typeName,
        COUNT(DISTINCT m.id) AS totalCount,
        COUNT(DISTINCT CASE WHEN m.achievement_status = 'APPROVED' THEN m.id END) AS approvedCount
        FROM achievement_mains m
        LEFT JOIN achievement_mains_achievement_type_id_lnk l
        ON l.achievement_main_id = m.id
        LEFT JOIN achievement_types t
        ON t.id = l.achievement_type_id
        AND (t.is_delete IS NULL OR t.is_delete = 0)
        WHERE (m.is_delete IS NULL OR m.is_delete = 0)
        AND m.`year` IS NOT NULL
        AND m.`year` != ''
        AND CAST(m.`year` AS UNSIGNED) <![CDATA[>=]]> #{fromYear}
        AND CAST(m.`year` AS UNSIGNED) <![CDATA[<=]]> #{toYear}
        AND m.achievement_status != 'DRAFT'
        AND m.published_at IS NOT NULL
        GROUP BY CAST(m.`year` AS UNSIGNED), t.type_code, t.type_name
        ORDER BY CAST(m.`year` AS UNSIGNED), t.type_code
    </select>
    <select id="pageList4admin" resultMap="AchListVOMap">
            SELECT
            m.document_id                 AS documentId,
            m.title              AS title,
            t.type_name          AS typeName,
            m.achievement_status AS auditStatus,
            m.authors          AS authors,
            /*,
            p.project_name       AS projectName,*/
            m.summary            AS summary,
            m.created_at         AS createdAt,
            m.visibility_range      AS visibilityRange
            FROM achievement_mains m

            LEFT JOIN achievement_mains_achievement_type_id_lnk mt
            ON mt.achievement_main_id = m.id
            LEFT JOIN achievement_types t
            ON t.id = mt.achievement_type_id

            /*LEFT JOIN admin_users au
            ON au.id = m.created_by_id

            LEFT JOIN projects p
            ON p.id = m.project_id*/

            WHERE m.is_delete = 0
            AND m.published_at IS NOT NULL

            <!-- 只查 ALL 可见
            AND m.visibility_range = 'public'
            AND m.achievement_status = 'APPROVED'-->
            <if test="dto.typeId != null">
                AND mt.achievement_type_id = #{dto.typeId}
            </if>
            <if test="dto.typeCode != null and dto.typeCode != ''">
                AND t.type_code = #{dto.typeCode}
            </if>
            <!-- 成果物年份范围：按 m.year（String）字段，区间 [yearStart, yearEnd] -->
            <if test="dto.yearStart != null and dto.yearStart != '' and dto.yearEnd != null and dto.yearEnd != ''">
                AND m.`year` IS NOT NULL
                AND CAST(m.`year` AS UNSIGNED) <![CDATA[ >= ]]> CAST(#{dto.yearStart} AS UNSIGNED)
                AND CAST(m.`year` AS UNSIGNED) <![CDATA[ <= ]]> CAST(#{dto.yearEnd} AS UNSIGNED)
            </if>

            <!-- 可选：只传 start 或只传 end 时也能用 -->
            <if test="(dto.yearStart != null and dto.yearStart != '') and (dto.yearEnd == null or dto.yearEnd == '')">
                AND m.`year` IS NOT NULL
                AND CAST(m.`year` AS UNSIGNED) <![CDATA[ >= ]]> CAST(#{dto.yearStart} AS UNSIGNED)
            </if>

            <if test="(dto.yearEnd != null and dto.yearEnd != '') and (dto.yearStart == null or dto.yearStart == '')">
                AND m.`year` IS NOT NULL
                AND CAST(m.`year` AS UNSIGNED) <![CDATA[ <= ]]> CAST(#{dto.yearEnd} AS UNSIGNED)
            </if>


            ORDER BY m.created_at DESC
    </select>
    <select id="pageListMySelf" resultMap="AchListVOMap">
        SELECT
        m.document_id        AS documentId,
        m.title              AS title,
        t.type_name          AS typeName,
        m.achievement_status AS auditStatus,
        m.keywords         AS keywords,
        m.authors          AS authors,
        m.year              AS year,
        m.project_name       AS projectName,
        m.summary            AS summary,
        m.created_at         AS createdAt,
        m.visibility_range   AS visibilityRange
        FROM achievement_mains m

        LEFT JOIN achievement_mains_achievement_type_id_lnk mt
        ON mt.achievement_main_id = m.id
        LEFT JOIN achievement_types t
        ON t.id = mt.achievement_type_id
        LEFT JOIN business_users au
        ON au.id = m.created_by_user_id

        <!-- 方式B：如果是 Strapi 多对多/多对一 link 表（按你实际表名改）
        LEFT JOIN achievement_mains_project_id_lnk mp
            ON mp.achievement_main_id = m.id
        LEFT JOIN projects p
            ON p.id = mp.project_id
        -->

        WHERE m.is_delete = 0
        AND m.published_at IS NOT NULL

        <!-- 个人成果物：强制按创建者过滤-->
        AND m.created_by_user_id = #{dto.creatorId}
        <if test="dto.title!=null and dto.title !=''">
            AND m.title LIKE CONCAT('%', #{dto.title}, '%')
        </if>
        <if test="dto.status != null and dto.status != ''">
            AND m.achievement_status = #{dto.status}
        </if>

        <!-- 只有在明确查询待分配审核的成果时才添加未分配审核人的条件 -->
        <if test="dto.onlyUnassigned != null and dto.onlyUnassigned == true and dto.status == 'PENDING'">
            AND m.reviewer_id IS NULL
        </if>

        <if test="dto.typeId != null">
            AND mt.achievement_type_id = #{dto.typeId}
        </if>
        <if test="dto.typeCode != null and dto.typeCode != ''">
            AND t.type_code = #{dto.typeCode}
        </if>
        <if test="dto.author != null and dto.author.trim() != ''">
            AND (
            JSON_SEARCH(m.authors, 'one', CONCAT('%', TRIM(#{dto.author}), '%')) IS NOT NULL
            OR JSON_SEARCH(m.authors, 'all', CONCAT('%', TRIM(#{dto.author}), '%')) IS NOT NULL
            )
        </if>
        <if test="dto.keyword != null and dto.keyword.trim() != ''">
            AND (
            JSON_SEARCH(m.keywords, 'one', CONCAT('%', TRIM(#{dto.keyword}), '%')) IS NOT NULL
            OR JSON_SEARCH(m.keywords, 'all', CONCAT('%', TRIM(#{dto.keyword}), '%')) IS NOT NULL
            )
        </if>
        <if test="dto.visibilityRange != null and dto.visibilityRange != ''">
            AND m.visibility_range = #{dto.visibilityRange}
        </if>
        <!-- 成果物年份范围：按 m.year（String）字段，区间 [yearStart, yearEnd] -->
        <if test="dto.yearStart != null and dto.yearStart != '' and dto.yearEnd != null and dto.yearEnd != ''">
            AND m.`year` IS NOT NULL
            AND CAST(m.`year` AS UNSIGNED) <![CDATA[ >= ]]> CAST(#{dto.yearStart} AS UNSIGNED)
            AND CAST(m.`year` AS UNSIGNED) <![CDATA[ <= ]]> CAST(#{dto.yearEnd} AS UNSIGNED)
        </if>

        <!-- 可选：只传 start 或只传 end 时也能用 -->
        <if test="(dto.yearStart != null and dto.yearStart != '') and (dto.yearEnd == null or dto.yearEnd == '')">
            AND m.`year` IS NOT NULL
            AND CAST(m.`year` AS UNSIGNED) <![CDATA[ >= ]]> CAST(#{dto.yearStart} AS UNSIGNED)
        </if>

        <if test="(dto.yearEnd != null and dto.yearEnd != '') and (dto.yearStart == null or dto.yearStart == '')">
            AND m.`year` IS NOT NULL
            AND CAST(m.`year` AS UNSIGNED) <![CDATA[ <= ]]> CAST(#{dto.yearEnd} AS UNSIGNED)
        </if>
        ORDER BY m.created_at DESC
    </select>


</mapper>

