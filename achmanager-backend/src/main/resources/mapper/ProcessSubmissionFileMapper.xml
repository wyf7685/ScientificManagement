<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.achievement.mapper.ProcessSubmissionFileMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.achievement.domain.po.ProcessSubmissionFile">
        <id column="file_id" property="fileId" />
        <result column="submission_id" property="submissionId" />
        <result column="file_name" property="fileName" />
        <result column="original_name" property="originalName" />
        <result column="file_size" property="fileSize" />
        <result column="file_type" property="fileType" />
        <result column="mime_type" property="mimeType" />
        <result column="file_path" property="filePath" />
        <result column="file_url" property="fileUrl" />
        <result column="file_category" property="fileCategory" />
        <result column="file_description" property="fileDescription" />
        <result column="file_md5" property="fileMd5" />
        <result column="storage_status" property="storageStatus" />
        <result column="uploader_id" property="uploaderId" />
        <result column="uploader_name" property="uploaderName" />
        <result column="upload_time" property="uploadTime" />
        <result column="create_by" property="createBy" />
        <result column="create_time" property="createTime" />
        <result column="update_by" property="updateBy" />
        <result column="update_time" property="updateTime" />
        <result column="del_flag" property="delFlag" />
        <result column="remark" property="remark" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        file_id, submission_id, file_name, original_name, file_size, file_type, mime_type,
        file_path, file_url, file_category, file_description, file_md5, storage_status,
        uploader_id, uploader_name, upload_time, create_by, create_time, update_by, update_time, del_flag, remark
    </sql>

    <!-- 根据提交物ID查询文件列表 -->
    <select id="selectBySubmissionId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM process_submission_files
        WHERE submission_id = #{submissionId}
          AND del_flag = '0'
        ORDER BY upload_time ASC
    </select>

    <!-- 根据文件分类查询文件列表 -->
    <select id="selectBySubmissionIdAndCategory" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM process_submission_files
        WHERE submission_id = #{submissionId}
          AND file_category = #{fileCategory}
          AND del_flag = '0'
        ORDER BY upload_time ASC
    </select>

    <!-- 根据文件ID查询文件信息 -->
    <select id="selectByFileId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM process_submission_files
        WHERE file_id = #{fileId}
          AND del_flag = '0'
    </select>

    <!-- 批量插入文件记录 -->
    <insert id="batchInsert">
        INSERT INTO process_submission_files (
            file_id, submission_id, file_name, original_name, file_size, file_type, mime_type,
            file_path, file_url, file_category, file_description, file_md5, storage_status,
            uploader_id, uploader_name, upload_time, create_by, create_time, del_flag
        ) VALUES
        <foreach collection="files" item="file" separator=",">
            (
                #{file.fileId}, #{file.submissionId}, #{file.fileName}, #{file.originalName},
                #{file.fileSize}, #{file.fileType}, #{file.mimeType}, #{file.filePath},
                #{file.fileUrl}, #{file.fileCategory}, #{file.fileDescription}, #{file.fileMd5},
                #{file.storageStatus}, #{file.uploaderId}, #{file.uploaderName}, #{file.uploadTime},
                #{file.createBy}, #{file.createTime}, '0'
            )
        </foreach>
    </insert>

    <!-- 更新文件存储状态 -->
    <update id="updateStorageStatus">
        UPDATE process_submission_files
        SET storage_status = #{status},
            update_time = NOW()
        WHERE file_id = #{fileId}
    </update>

</mapper>