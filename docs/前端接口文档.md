# 前端接口文档

面向后端实现的接口清单与约定，依据前端当前实现梳理。

## 通用约定

- 基础路径：`VITE_API_BASE_URL`，未配置时为 `/api`。
- 认证方式：`Authorization: Bearer <token>`（除登录接口外，默认需要）。
- 超时：15s。
- 成功响应（业务接口）：
  ```json
  { "code": 200, "message": "ok", "data": {} }
  ```
  - 兼容 `code` 为 `200/1/0` 或字符串形式。
- Strapi 风格响应（无 `code`）：
  ```json
  { "data": ..., "meta": ... }
  ```
- 列表分页（成果列表类接口）：
  ```json
  { "code": 200, "data": { "records": [], "total": 0, "current": 1, "size": 10 } }
  ```
- 文件上传：
  - `Content-Type: multipart/form-data`
  - 表单字段：
    - `data`: JSON 字符串（业务数据）
  - `files`: 文件数组（多文件）

## 值域约定

- 成果状态（前端展示）：`draft | pending | reviewing | revision | rejected | published | revoked`
- 成果状态（后端枚举）：`PENDING | UNDER_REVIEW | APPROVED | REJECTED | NEEDS_MODIFICATION`
- 可见范围：`private | internal_abstract | internal_full | public_abstract | public_full`
- 审核动作：`approve | reject`

## 认证与用户

### 登录
- `POST /auth/login`
- 请求体：
  ```json
  { "username": "string", "password": "string" }
  ```
- 响应 `data`：
  ```json
  { "token": "string", "user": { "id": "...", "name": "...", "role": "..." } }
  ```

### 登出
- `POST /auth/logout`
- 响应：`data: true`

### 获取当前用户
- `GET /auth/current`
- 响应：`data` 为当前用户信息

### 获取专家用户列表
- `GET /users/experts`
- 响应：`data` 为数组

### 获取业务用户列表
- `GET /users`
- 查询参数：任意过滤字段
- 响应：`data` 为数组

## 项目

### 项目列表（Strapi）
- `GET /projects`
- 响应（Strapi 集合）：
  ```json
  { "data": [ { "id": "...", "name": "...", "code": "..." } ], "meta": {} }
  ```

### 项目详情（Strapi）
- `GET /projects/{id}`
- 响应（Strapi 单体）：
  ```json
  { "data": { "id": "...", "name": "...", "code": "..." }, "meta": {} }
  ```

### 创建项目
- `POST /projects`
- 请求体：
  ```json
  { "name": "string", "code": "string" }
  ```
- 响应：`data` 为创建后的项目

## 成果（Results）

### 统计与分布
- `GET /results/statistics`：系统统计
- `GET /results/my-statistics`：个人统计
- `GET /admin/stat/typePie`：成果类型饼图（可选 `creatorId`）
- `GET /results/advanced-distribution`：高级分布
- `GET /results/stacked-trend`：堆叠趋势
- `GET /results/keywords`：热点关键词图谱

### 成果列表（分页）

统一请求体结构（前端会从 ` 组装）：
```json
{
  "pageNum": 1,
  "pageSize": 10,
  "mainTitle": "keyword",
  "typeId": "typeDocId",
  "status": "PENDING | UNDER_REVIEW | APPROVED | REJECTED | NEEDS_MODIFICATION",
  "projectId": "string"
}
```

- `POST /admin/achievement/pageList`：管理员视角
- `POST /user/achievement/pageListAllVisible`：可见范围
- `POST /user/achievement/pageList`：我的成果

响应：`data.records` 为列表项，前端将读取以下字段（命名可兼容）：
- `documentId` 或 `id`
- `auditStatus` 或 `status`（会映射成 `pending/reviewing/published/rejected/revision`）
- `typeName` 或 `type`
- `authorName`/`creatorName`
- `visibilityRange` 或 `visibility`
- `createdBy`/`creatorName`

### 成果详情
- `GET /user/achievement/detail?achDocId={id}`
- 响应 `data` 关键字段示例：
  ```json
  {
    "documentId": "string",
    "title": "string",
    "summary": "string",
    "typeDocId": "string",
    "typeName": "string",
    "typeCode": "string",
    "year": "2024",
    "authors": ["A", "B"],
    "keywords": ["k1"],
    "projectName": "string",
    "projectCode": "string",
    "visibilityRange": "internal_abstract",
    "auditStatus": "PENDING",
    "fields": [ { "fieldCode": "doi", "value": "..." } ],
    "attachments": {
      "data": [
        {
          "attributes": {
            "files": {
              "data": [
                { "id": 1, "attributes": { "name": "...", "url": "/uploads/...", "size": 123, "mime": "..." } }
              ]
            }
          }
        }
      ]
    }
  }
  ```

### 创建成果
- `POST /user/achievement/create`
- 请求体：
  ```json
  {
    "data": {
      "title": "string",
      "year": "2024",
      "authors": ["A"],
      "keywords": ["k1"],
      "summary": "string",
      "achievementStatus": "PENDING",
      "typeDocId": "string",
      "projectCode": "string",
      "projectName": "string",
      "visibilityRange": "internal_abstract",
      "fields": [
        {
          "achievement_field_def_id": "fieldDocId",
          "textValue": "string | null",
          "numberValue": 0,
          "booleanValue": true,
          "dateValue": "YYYY-MM-DD"
        }
      ]
    }
  }
  ```

### 创建成果（带附件）
- `POST /user/achievement/createWithFiles`
- `multipart/form-data`：
  - `data`: JSON 字符串（同创建成果）
  - `files`: 多文件

### 更新成果
- `PUT /user/achievement/update/{id}`
- 请求体与创建一致，但不包含 `achievementStatus`

### 更新成果（带附件）
- `PUT /user/achievement/updateWithFiles/{id}`
- `multipart/form-data` 同上

### 删除成果（逻辑删除）
- `PUT /admin/achievement/delete/{id}`

### 草稿
- `POST /results/draft`
- 请求体：前端直接提交表单数据（包含 `metadata`、`projectName`、`projectCode`）

### 审核流程
- `：提交审核
- `POST /results/{id}/review`：审核成果  
  请求体：`{ "action": "approve|reject", "comment": "string" }`
- `POST /results/{id}/assign-reviewers`：分配审核人  
  请求体：`{ "reviewerIds": ["id"], "reviewerNames": ["name"] }`
- `POST /results/{id}/request-changes`：退回修改  
  请求体：`{ "reason": "string" }`
- `POST /results/{id}/format-check`：格式审查通过
- `POST /results/{id}/format-reject`：格式审查退回  
  请求体：`{ "reason": "string" }`

### 审核列表

#### 审核待办
- `GET /results/review-backlog`
- 查询参数：
  - `page`: 页码（可选，默认 1）
  - `pageSize`: 每页数量（可选，默认 10）
  - 其他筛选参数（可选）
- 响应：
  ```json
  {
    "code": 200,
    "data": {
      "records": [
        {
          "documentId": "string",
          "id": "string",
          "title": "string",
          "auditStatus": "UNDER_REVIEW",
          "typeName": "string",
          "authorName": "string",
          "creatorName": "string",
          "visibilityRange": "internal_abstract",
          "createdBy": "string",
          "createdAt": "ISO8601",
          "updatedAt": "ISO8601"
        }
      ],
      "total": 100,
      "current": 1,
      "size": 10
    }
  }
  ```

#### 审核历史
- `GET /results/review-history`
- 查询参数：
  - `page`: 页码（可选，默认 1）
  - `pageSize`: 每页数量（可选，默认 10）
  - 其他筛选参数（可选）
- 响应：
  ```json
  {
    "code": 200,
    "data": {
      "records": [
        {
          "documentId": "string",
          "id": "string",
          "type": "string",
          "typeName": "string",
          "projectName": "string",
          "projectCode": "string",
          "reviewResult": "approve",
          "action": "approve",
          "reviewedAt": "ISO8601",
          "comment": "string"
        }
      ],
      "total": 50,
      "current": 1,
      "size": 10
    }
  }
  ```
- 说明：
  - `reviewResult` 或 `action` 字段表示审核结果（`approve` 或 `reject`）
  - 前端会将 `reviewResult` 或 `action` 映射为统一的审核动作
  - 响应字段命名可兼容（`documentId`/`id`、`reviewResult`/`action`）

### 成果访问申请
- `POST /results/{id}/access-requests`：申请查看全文  
  请求体：`{ "reason": "string" }`（或自定义字段）
- `GET /results/access-requests`：申请列表（分页）
- `POST /results/access-requests/{id}/review`：审批  
  请求体：`{ "action": "approve|reject", "comment": "string" }`

### 导出
- `GET /results/export`
- 响应：`Blob`（Excel）

### 智能补全
- `GET /results/auto-fill`
- 查询参数：
  - `type`: `doi | arxiv | wanfang | journalRank`
  - `value`: string
- 响应：
  - `type != journalRank`：`data` 为表单字段集合（title/authors/abstract/keywords/metadata 等）
  - `type == journalRank`：`data` 为期刊等级列表

### 附件上传
- `POST /upload`
- `multipart/form-data`：`file` 单文件

## 成果类型与动态字段

### 成果类型
- `POST /achievementType/list`  
  响应：`data` 为类型数组
- `POST /achievementType/types`  
  请求体：
  ```json
  { "data": { "type_name": "string", "type_code": "string", "description": "string", "is_delete": 0 } }
  ```
- `PUT /achievementType/types/{documentId}`  
  请求体同上
- `PUT /achievementType/types/{documentId}/delete`：逻辑删除

### 动态字段定义
- `GET /achievementType/detail?typeDocId={documentId}`  
  响应 `data.fieldDefinitions` 为字段数组
- `POST /achievementFieldDef/create`  
  请求体：
  ```json
  {
    "data": {
      "field_code": "string",
      "field_name": "string",
      "field_type": "TEXT|NUMBER|DATE|BOOLEAN|RICHTEXT|JSON|MEDIA",
      "is_required": 0,
      "description": "string",
      "is_delete": 0,
      "achievement_type_id": "typeDocId"
    }
  }
  ```
- `PUT /achievementFieldDef/defs/{documentId}`  
  请求体同上，但不需要 `achievement_type_id`
- `PUT /achievementFieldDef/delete/{documentId}`：逻辑删除

## 中期成果物（过程系统）

### 统计
- `GET /interim-results/stats`
- 响应：`{ totalProjects, totalResults, byType, byYear, recentSyncTime }`

### 列表
- `GET /interim-results`
- 查询参数：`projectId/type/year/keyword/page/pageSize`
- 响应：
  ```json
  {
    "code": 200,
    "data": { "list": [], "total": 0, "page": 1, "pageSize": 10 }
  }
  ```

### 详情
- `GET /interim-results/{id}`

### 同步
- `POST /interim-results/sync`
- 请求体：`{ "projectId": "string" }`（可选）
- 响应：`{ syncCount, syncTime }`

### 附件下载
- `GET /interim-results/attachments/{id}/download`：直接返回文件流

### 批量下载
- `POST /interim-results/batch-download`
- 请求体：`{ "resultIds": ["id1", "id2"] }`
- 响应：`Blob`

### 导出
- `GET /interim-results/export`
- 查询参数：`projectId/type/year`
- 响应：`Blob`

## 企业需求（Demand）

### 列表
- `GET /demand`
- 查询参数：分页/筛选均为可选
- 响应：`data` 为需求列表（参考 `DemandItem` 结构）

### 详情
- `GET /demand/{id}`

### 重新匹配
- `POST /demand/{id}/rematch`

## 系统设置（爬虫）

### 数据源列表
- `GET /system/crawler-sources`

### 创建数据源
- `POST /system/crawler-sources`

### 更新数据源
- `PUT /system/crawler-sources/{id}`

### 删除数据源
- `DELETE /system/crawler-sources/{id}`

### 测试数据源
- `POST /system/crawler-sources/{id}/test`

### 爬虫设置
- `GET /system/crawler-settings`
- `PUT /system/crawler-settings`

数据结构示例：
```json
{
  "id": "string",
  "name": "string",
  "type": "rss|html|api|file",
  "industry": "string",
  "region": "string",
  "baseUrl": "string",
  "authType": "none|api_key|cookie|basic",
  "credentials": {},
  "frequencyHours": 6,
  "priority": "low|medium|high",
  "tags": [],
  "enabled": true,
  "lastRunAt": "ISO",
  "lastSuccessAt": "ISO",
  "status": "healthy|warning|error|idle",
  "failureReason": "string"
}
```

设置示例：
```json
{
  "defaultFrequencyHours": 8,
  "retryLimit": 3,
  "autoTagging": true,
  "deduplicateThreshold": 0.8,
  "notifyEmails": ["a@b.com"],
  "notifyWebhook": "https://..."
}
```
